{% extends "base.html" %}

{% block styles %}
<style>
/* ===== Body ===== */
body {
    background: linear-gradient(135deg, #f0f4f8, #d9e2f3);
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 0;
    text-align: center;
}

/* ===== Header ===== */
header {
    background-color: #be288c;
    color: white;
    padding: 20px 0;
    font-family: 'Poppins', sans-serif;
    font-size: 1.5rem;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
    transition: background-color 0.3s ease;
}

header:hover {
    background-color: #a71d63;
}

/* ===== Navbar ===== */
.navbar {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 10px;
}

.navbar button {
    background-color: white;
    color: #bf2d78;
    border: 2px solid #bf2d78;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.navbar button:hover {
    background-color: #bf2d78;
    color: white;
    transform: scale(1.1);
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}

/* ===== Page Heading ===== */
h2 {
    font-family: 'Poppins', sans-serif;
    color: #bf2d78;
    font-size: 2rem;
    margin: 25px 0;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    animation: fadeInDown 1s ease;
}

/* ===== Video ===== */
#video {
    border: 4px solid #bf2d78;
    border-radius: 16px;
    margin-top: 20px;
    width: 600px;
    height: 600px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    animation: fadeIn 1s ease;
}

/* ===== Scan Result ===== */
#scan-result {
    margin-top: 20px;
    font-size: 1.3rem;
    min-height: 1.5em;
    animation: fadeIn 0.5s ease;
}

.success { color: #2e7d32; font-weight: 600; }
.error { color: #c62828; font-weight: 600; }
.notice { color: #1565c0; font-style: italic; font-weight: 500; }

/* ===== Animations ===== */
@keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
}

@keyframes fadeInDown {
    from {opacity: 0; transform: translateY(-20px);}
    to {opacity: 1; transform: translateY(0);}
}
</style>
{% endblock %}

{% block title %}Scan QR Code{% endblock %}

{% block content %}
<!-- Header -->
<header>
    School Portal
    <div class="navbar">
        <button onclick="window.location.href='/dashboard'">Dashboard</button>
        <button onclick="window.location.href='/logout'">Logout</button>
    </div>
</header>

<!-- Main Content -->
<h2>Scan Attendance QR Code</h2>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas" hidden></canvas>

<div id="scan-result"></div>
{% endblock %}


{% block scripts %}
<script src="{{ url_for('static', filename='js/jsQR.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const resultContainer = document.getElementById('scan-result');
    let lastScanTime = 0;
    const scanCooldown = 5000; // 5 seconds

    // Ask for camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
        video.srcObject = stream;
        video.setAttribute("playsinline", true); // for iOS
        video.play();
        requestAnimationFrame(tick);
    })
    .catch(err => {
        console.error("Camera error:", err);
        resultContainer.innerHTML = "<p class='error'>Cannot access camera. Please allow permissions.</p>";
    });

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

            if (code) {
                let now = Date.now();
                if (now - lastScanTime >= scanCooldown) {
                    lastScanTime = now;
                    resultContainer.innerHTML = `<p class="notice">Scanned! Verifying...</p>`;

                    fetch('/api/mark_attendance', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: code.data })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            resultContainer.innerHTML = `<p class="success">✅ Attendance marked!</p>`;
                        } else {
                            resultContainer.innerHTML = `<p class="error">❌ ${data.error}</p>`;
                        }
                    })
                    .catch(err => {
                        console.error("Fetch error:", err);
                        resultContainer.innerHTML = `<p class="error">Request failed.</p>`;
                    });
                }
            }
        }
        requestAnimationFrame(tick);
    }
});
</script>
{% endblock %}
